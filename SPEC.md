# ТЗ: OBS Studio плагин «Styled Second Camera» (Rust)

## 1) Цель
Сделать современный плагин для OBS Studio, который позволяет добавить «вторую камеру» (facecam / PiP) как настраиваемый оверлей с:
- произвольной формой (круг / квадрат / прямоугольник / скруглённые углы),
- тенью/обводкой/мягкими краями,
- **обязательным размытием фона за человеком** (фон камеры размывается, человек остаётся резким),
- удобной настройкой и предсказуемым качеством/производительностью.

## 2) Платформы и ограничения
- Целевые ОС: **Windows**, **macOS**.
- Язык реализации: **Rust**.
- Формат поставки:
  - Windows: плагин OBS (`.dll`) + ресурсы (шейдеры/модели) в zip.
  - macOS: bundle плагина OBS (`.plugin`) + ресурсы.

## 3) Пользовательские сценарии
1) Записываю экран + показываю лицо «в уголке» в красивой форме (не обязательно круг).
2) Быстро меняю форму, размер, позицию, отступы, тень, рамку.
3) Включаю blur фона в камере: лицо/человек остаётся резким, задний фон размывается.
4) Хочу, чтобы это работало стабильно на Windows и macOS и не «убивало» FPS.

## 4) Что именно делает плагин (MVP)
Плагин добавляет новый Source в OBS:
- **`Styled Camera`** (рабочее название)

`Styled Camera` сам захватывает видеоустройство (как стандартный `Video Capture Device`), но рендерит картинку через GPU-пайплайн:
- сегментация человека (маска),
- blur фона (по маске),
- форма/маска кадра (круг/rounded-rect/…),
- тень/обводка/feather,
- итоговый композит.

Позиционирование и масштабирование — стандартными средствами OBS (transform у scene item).

## 5) Обязательные функции (Functional Requirements)
### 5.1 Захват камеры
- Выбор устройства камеры в свойствах источника.
- Выбор разрешения/частоты кадров (или «Default»).
- Flip (mirror) по горизонтали (опционально, но желательно).

### 5.2 Сегментация человека (обязательна)
- Получение маски «человек/фон» из видео.
- Настройки:
  - качество/скорость (например: Low/Medium/High),
  - сглаживание маски (feather),
  - подавление мерцания (temporal smoothing),
  - порог/мягкий порог (threshold/softness).

### 5.3 Blur фона за человеком (обязателен)
- Фон (не-человек) размывается, человек остаётся резким.
- Настройки:
  - сила blur (радиус/интенсивность),
  - качество blur (кол-во проходов / downscale фактор),
  - опционально: лёгкое затемнение/десатурация фона.

### 5.4 Форма и оформление «окошка» камеры
- Тип формы: Circle / Square / Rectangle / Rounded Rectangle.
- Для rounded rectangle:
  - радиус скругления,
  - независимые радиусы (опционально, можно позже).
- Feather (мягкий край/антиалиас).
- Обводка (border):
  - цвет,
  - толщина.
- Тень (drop shadow):
  - цвет,
  - смещение X/Y,
  - blur/softness,
  - непрозрачность.

### 5.5 Кадрирование
- Кроп по краям (Left/Right/Top/Bottom) внутри источника (чтобы можно было «приблизить» лицо).

### 5.6 Пресеты (желательно для MVP)
- Набор быстрых пресетов: “Circle + Shadow”, “Rounded card”, “Square minimal”.
- Кнопки: Save preset / Load preset (хранение в config OBS).

## 6) Требования к UX в OBS
- Настройки доступны в `Properties` источника.
- Названия параметров понятные, значения с адекватными дефолтами.
- Предпросмотр должен отражать изменения сразу (без перезапуска OBS).

## 7) Нефункциональные требования
### 7.1 Производительность
- Цель: 1080p@30fps на типичных машинах не должно приводить к заметному падению FPS в OBS при одном источнике `Styled Camera`.
- Стратегии оптимизации (должны быть предусмотрены):
  - запуск сегментации на пониженном разрешении (например 256–512 по меньшей стороне) с апскейлом маски,
  - обновление маски не на каждом кадре (например 15fps) + интерполяция/temporal smoothing,
  - blur через downsample + separable blur (быстрые проходы).

### 7.2 Качество картинки
- Минимизация “ореолов” вокруг волос/контуров (насколько возможно выбранной моделью).
- Отсутствие видимых ступенек на границе формы (антиалиас/feather).

### 7.3 Стабильность
- Не должно быть утечек ресурсов GPU/CPU при добавлении/удалении источника.
- Корректная работа при смене сцены/переключении источника/изменении свойств.

## 8) Техническое решение (высокоуровнево)
### 8.1 Общий подход
- Плагин OBS (API на C) + реализация на Rust через FFI (`cdylib`).
- Рендер эффектов (форма/тень/blur) — на GPU через шейдеры OBS (`.effect`).
- Сегментация — inference модели (подробнее ниже), результат — маска, используемая в GPU-композите.

### 8.2 Inference backend (требуется выбрать при реализации)
Цель — поддержать Windows и macOS.
Варианты (выбор зависит от доступности и стабильности в экосистеме):
- ONNX Runtime:
  - Windows: DirectML EP (GPU) или CPU fallback,
  - macOS: CoreML EP (если подходит) или CPU fallback.
- Альтернатива: CPU-only в MVP (с пониженным разрешением маски) с последующей оптимизацией.

Модель сегментации (кандидаты, уточнить на этапе реализации):
- Selfie/Person segmentation модель в ONNX (лёгкая, realtime).

### 8.3 Пайплайн композита (идея)
1) Входной кадр камеры.
2) Маска человека `M` (0..1).
3) Blur-версия кадра `B` (через downsample + blur).
4) Композит “человек поверх blur фона”:
   - `Out = Camera * M + B * (1 - M)`
5) Применение формы окна (shape mask) + border/shadow.

## 9) Критерии приемки (Acceptance Criteria)
- На Windows и macOS можно добавить `Styled Camera` и выбрать камеру.
- Blur фона за человеком работает (человек резкий, фон размыт) и настраивается.
- Форма переключается между кругом/квадратом/прямоугольником/rounded-rect.
- Тень и обводка визуально корректны и настраиваются.
- Источник корректно двигается/масштабируется стандартными инструментами OBS.

## 10) Не входит в MVP (но можно позже)
- Несколько человек/сложные маски (multi-person).
- Трекинг лица и авто-кадрирование.
- Анимированные переходы/кейфреймы внутри источника.
- Интеграция со стрим-деком/горячие клавиши под пресеты.

## 10.1 Дистрибуция и установка (без подписи)
Так как код не подписывается (Windows Authenticode / macOS Developer ID + notarization отсутствуют), основной способ дистрибуции для MVP:
- **ZIP-архивы** с ручной установкой.
- В репозитории поддерживаются install/uninstall скрипты для копирования файлов в правильные директории.

### macOS (user-level install)
- Путь установки: `~/Library/Application Support/obs-studio/plugins/StyledCamera.plugin`
- Рекомендуемый способ:
  - `./scripts/install-macos.sh /path/to/StyledCamera.plugin`
- Если после скачивания macOS блокирует загрузку (quarantine), скрипт снимает атрибут:
  - `xattr -dr com.apple.quarantine ...` (best-effort)
- Примечание по архитектурам:
  - релизы должны быть либо `universal` (arm64+x86_64), либо отдельные архивы `macos-arm64` и `macos-x86_64`.

### Windows (user-level install)
- Путь установки: `%APPDATA%\\obs-studio\\plugins\\StyledCamera\\`
- Ожидаемая структура:
  - `bin\\64bit\\StyledCamera.dll`
  - `data\\...` (шейдеры/модель/ресурсы)
- Рекомендуемый способ:
  - `powershell -ExecutionPolicy Bypass -File .\\scripts\\install-windows.ps1 -Source C:\\path\\to\\StyledCamera`

## 11) Tasks breakdown (план работ)
### 11.1 Repo / build / devx
- [ ] Создать Cargo workspace (`crates/`), настроить `cdylib` под Windows/macOS.
- [ ] Добавить подмодули/зависимости OBS (или указать путь к OBS headers/libobs) и базовую сборку плагина.
- [ ] Настроить структуру плагина: `data/` (шейдеры `.effect`, пресеты/ресурсы), `src/` (Rust), минимальный логгер.
- [ ] Сделать скрипты сборки/упаковки:
  - [ ] Windows zip layout для OBS,
  - [ ] macOS `.plugin` bundle layout.
- [ ] CI (по возможности): сборка Windows + macOS, артефакты релиза.

### 11.2 OBS plugin skeleton
- [ ] Реализовать загрузку/инициализацию модуля OBS (entrypoints), регистрацию нового Source `Styled Camera`.
- [ ] Базовые свойства Source (имя устройства, режим/разрешение/FPS, mirror).
- [ ] Создать минимальный рендер-пайплайн: текстура камеры → вывод без эффектов.

### 11.3 Camera capture
- [ ] Интеграция с девайсами (через OBS API для video capture source или собственный захват, выбрать подход).
- [ ] Обработка смены устройства/формата на лету без крэшей.
- [ ] Кроп/зум (внутренние параметры источника).

### 11.4 Segmentation (person mask)
- [ ] Выбрать inference backend для Windows/macOS (кандидат: ONNX Runtime).
- [ ] Встроить/подключить модель сегментации (onnx), определить входной размер, препроцесс/постпроцесс.
- [ ] Асинхронный inference-поток (не блокировать render thread OBS).
- [ ] Temporal smoothing/стабилизация маски.
- [ ] Настройки качества: размер маски, FPS маски, threshold/softness.

### 11.5 Background blur (обязательная фича)
- [ ] Реализовать GPU blur (downsample + separable/Kawase) на текстуре камеры.
- [ ] Скомпозитить “человек резкий + фон blur” по маске.
- [ ] Настройки blur: интенсивность, качество (downscale factor / passes), опционально dim/desat.

### 11.6 Shape + styling (рамка/тень/форма)
- [ ] Shape mask: Circle / Square / Rectangle / Rounded Rect (SDF в шейдере).
- [ ] Feather/AA на границе формы.
- [ ] Border: цвет/толщина.
- [ ] Drop shadow: цвет/смещение/softness/opacity.

### 11.7 Properties UI + presets
- [ ] Сгруппировать параметры в OBS Properties (Capture / Segmentation / Blur / Shape / Style / Presets).
- [ ] Пресеты: Save/Load, хранение в config OBS, формат стабильный между версиями.

### 11.8 Packaging + docs
- [ ] Документация установки (Windows/macOS) + FAQ (производительность/совместимость).
- [ ] Версионирование и совместимость OBS (минимальная версия OBS).
- [ ] Release checklist (проверки FPS, утечек, удаление источника, смена сцен).
